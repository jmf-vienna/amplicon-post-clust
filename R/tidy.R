tidy_counts_matrix <- function(counts_matrix) {
  counts_raw <-
    counts_matrix |>
    rename(feature := 1L) |>
    pivot_longer(!feature, names_to = "sample", values_to = "count") |>
    filter(count > 0L) |>
    mutate(
      count = count |> as.integer(),
      orientation = if_else(str_ends(sample, fixed(".R")), "reverse", "forward")
    ) |>
    arrange(feature, sample)

  observations <-
    counts_raw |>
    count(feature, sample) |>
    filter(n != 1L)

  if (nrow(observations) > 0L) {
    cli_abort(
      "Found duplicate observations in the counts matrix. Please make sure each combination of sample and feature is unique!"
    )
  }

  counts_raw
}

tidy_counts <- function(counts_raw, features) {
  counts_raw |>
    left_join(features |> select(feature, orientation, new_feature_id), by = join_by(feature, orientation))
}

trim_counts <- function(counts, feature_id_var, sample_id_var, count_var) {
  counts |>
    select(new_feature_id, sample, count) |>
    arrange(new_feature_id, sample) |>
    rename("{feature_id_var}" := new_feature_id, "{sample_id_var}" := sample, "{count_var}" := count)
}

tidy_features <- function(features_sequences, counts_raw) {
  loadNamespace("Biostrings")

  features <- tibble(
    feature = features_sequences |> names() |> str_remove(";.+"),
    Sequence_length = BiocGenerics::width(features_sequences),
    seq = as.character(features_sequences),
    seq_revcomp = features_sequences |> Biostrings::reverseComplement() |> as.character()
  ) |>
    arrange(feature)

  orientation <- counts_raw |> distinct(feature, orientation)

  stopifnot(identical(features[["feature"]], orientation[["feature"]]))

  features |>
    left_join(orientation, by = "feature") |>
    mutate(
      Sequence = if_else(orientation == "reverse", seq_revcomp, seq),
      new_feature_id = Sequence |> openssl::sha1()
    )
}

trim_features <- function(features, feature_id_var) {
  features |>
    distinct(new_feature_id, Sequence_length, Sequence) |>
    arrange(new_feature_id) |>
    rename("{feature_id_var}" := new_feature_id)
}
